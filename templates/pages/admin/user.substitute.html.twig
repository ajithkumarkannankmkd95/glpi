{#
 # ---------------------------------------------------------------------
 #
 # GLPI - Gestionnaire Libre de Parc Informatique
 #
 # http://glpi-project.org
 #
 # @copyright 2015-2022 Teclib' and contributors.
 # @copyright 2003-2014 by the INDEPNET Development Team.
 # @licence   https://www.gnu.org/licenses/gpl-3.0.html
 #
 # ---------------------------------------------------------------------
 #
 # LICENSE
 #
 # This file is part of GLPI.
 #
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
 # the Free Software Foundation, either version 3 of the License, or
 # (at your option) any later version.
 #
 # This program is distributed in the hope that it will be useful,
 # but WITHOUT ANY WARRANTY; without even the implied warranty of
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 # GNU General Public License for more details.
 #
 # You should have received a copy of the GNU General Public License
 # along with this program.  If not, see <https://www.gnu.org/licenses/>.
 #
 # ---------------------------------------------------------------------
 #}
{% import 'components/form/fields_macros.html.twig' as fields %}

<div class="asset">

{# Form Header #}
{% set target       = params['target'] ?? item.getFormURL() %}
{% set canedit      = params['canedit'] ?? true %}
{% set rand         = random() %}
{% set id           = item.fields['id'] ?? -1 %}
{% set formoptions  = params['formoptions'] ?? '' %}

{% set entity_id = 0 %}
{% set entity_name = '' %}
{% if item.isEntityAssign() %}
   {% if item.getType() == 'Entity' and item.fields['id'] == 0 %}
      {% set entity_id = null %}
   {% else %}
      {% set entity_id = params['entities_id'] ?? item.getEntityID() ?? session('glpiactive_entity') %}
   {% endif %}

   {% if is_multi_entities_mode() %}
      {% set entity_name = get_item_name('Entity', item.getEntityID()) %}
   {% endif %}
{% endif %}

{% if item.canEdit(user.fields['id']) %}
   <form name="asset_form" method="post" action="{{ target }}" {{ formoptions|raw }} enctype="multipart/form-data" data-submit-once>
      <input type="hidden" name="entities_id" value="{{ entity_id }}" />
      {% if _request['_in_modal'] is defined and _request['_in_modal'] == "1" %}
         <input type="hidden" name="_in_modal" value="1"/>
      {% endif %}
{% endif %}

   <div id="mainformtable">
      {% set template_name = item.fields['template_name']|verbatim_value %}
      {% if withtemplate == 2 and not item.isNewItem() %}
         <input type="hidden" name="template_name" value="{{ template_name }}" />
         {% set nametype = __('Created from the template %s')|format(template_name) %}
      {% elseif withtemplate == 1 %}
         <input type="hidden" name="is_template" value="1" />
      {% elseif item.isNewItem() %}
         {% set nametype = __('%1$s - %2$s')|format(__('New item'), nametype) %}
      {% else %}
         {% if noid == false and (session('glpiis_ids_visible') or nametype|length == 0) %}
            {% set nametype = __('%1$s - %2$s')|format(nametype, item.fields['id']) %}
         {% endif %}
      {% endif %}

      {{ call_plugin_hook(constant('Glpi\\Plugin\\Hooks::PRE_ITEM_FORM'), {'item': item, 'options': params}) }}

      {# todo modal message #}
      {% if app.request.request('in_modal') == true %}
      <input type="hidden" name="_no_message_link" value="1" />
      {% endif %}

      {% set rand = random() %}
      {% set params  = params ?? [] %}
      {% set target       = params['target'] ?? item.getFormURL() %}
      {% set withtemplate = params['withtemplate'] ?? '' %}
      {% set item_type = item.getType() %}
      {% set item_has_pictures = item.hasItemtypeOrModelPictures() %}
      {% set field_options = {
         'locked_fields': item.getLockedFields(),
      } %}

      <div class="card-body d-flex flex-wrap">
         <div class="col-12 col-xxl-{{ item_has_pictures ? '9' : '12' }} flex-column">
            <div class="d-flex flex-row flex-wrap flex-xl-nowrap">
               <div class="row flex-row align-items-start flex-grow-1">
                  <div class="row flex-row">
                     <input type="hidden" name="users_id" value={{ user.fields['id'] }} />
                     {% if (delegators) %}
                     {% endif %}
                     {{ fields.datetimeField(
                        'substitution_start_date',
                        user.fields['substitution_start_date'],
                        __('Start date ')
                     ) }}

                     {{ fields.datetimeField(
                        'substitution_end_date',
                        user.fields['substitution_end_date'],
                        __('End date ')
                     ) }}

                     {{ fields.dropdownField(
                        'User',
                        'substitutes',
                        [],
                        __('Validation substitutes'),
                        {
                              'multiple': 'multiple',
                              'used': [user.fields['id']],
                              'value': substitutes,
                              'right': 'create_ticket_validate',
                              'rand': rand,
                        }
                     ) }}

                     {{ fields.nullField }}

                     {% if delegators|length > 0 %}
                        <div class="card border-0 shadow-none p-0 m-0 mt-2 mb-2">
                           <div class="card-header mb-1 p-0 ps-3">{{ __('Validation delegators') }}</div>
                        </div>
                        <table class="table card-table table-hover table-striped">
                        <thead>
                           <tr>
                              <th style="width: 33%;">{{ __('name') }}</th>
                              <th style="width: 33%;">{{ __('Substitution start date') }}</th>
                              <th style="width: 33%;">{{ __('Substitution end date') }}</th>
                           </tr>
                        </thead>
                        <tbody>
                        {% for delegator in delegators %}
                           {% set delegator = get_item('User', delegator) %}
                           <tr>
                              <td valign="top">{{ delegator.getFriendlyName() }}</td>
                              <td valign="top">{{ delegator.fields['substitution_start_date'] }}</td>
                              <td valign="top">{{ delegator.fields['substitution_end_date'] }}</td>
                           </tr>
                        {% endfor %}
                        </tbody>
                        </table>
                     {% endif %}

                  </div> {# .row #}
               </div> {# .row #}
            </div> {# .flex-row #}
         </div>
         {% if item_has_pictures %}
            <div class="col-12 col-xxl-3 flex-column">
               <div class="flex-row asset-pictures">
                  {{ include('components/form/pictures.html.twig', {'gallery_type': ''}) }}
               </div>
            </div>
         {% endif %}
      </div> {# .card-body #}


      {% set withtemplate = params['withtemplate'] ?? '' %}
      {% set candel       = params['candel'] ?? true %}
      {% set canedit      = params['canedit'] ?? true %}
      {% set id           = item.fields['id'] ?? -1 %}

      <div class="row">
      {{ call_plugin_hook(constant('Glpi\\Plugin\\Hooks::POST_ITEM_FORM'), {'item': item, 'options': params}) }}
      </div>

      {% if canedit or item.canEdit(user.fields['id']) %}
         <div class="card-body mx-n2 mb-4 border-top d-flex flex-row-reverse align-items-start flex-wrap">
            <button class="btn btn-primary me-2" type="submit" name="update" value="1">
               <i class="far fa-save"></i>
               <span>{{ _x('button', 'Save') }}</span>
            </button>
         </div>

         <input type="hidden" name="_glpi_csrf_token" value="{{ csrf_token() }}" />
      </div> {# #mainformtable #}
   </form> {# [name=asset_form] #}
   {% else %}
      </div> {# #mainformtable #}
   {% endif %}
</div>
